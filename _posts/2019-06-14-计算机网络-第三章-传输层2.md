---
layout: page
title: 计算机网络-第三章-传输层2
mermaid: true
---



# 计算机网络-第三章-传输层2



## 面向连接运输：TCP

TCP的报文结构如下所示：

![tcp_format](../img/tcp_format.png)

源端口号、目的端口号这个不用多说，肯定是必须的。

序号是对应数据包的序号，解决乱序问题的，不然怎么知道哪个数据包在前哪个在后呢。

确认号是确认发送的包有没有正确接收的，比如确认号45，则说明45序号之前的包都已经收到。

随后便是一些状态字段，例如 SYN 是发起一个连接，ACK 是回复，RST 是重新连接，FIN 是结束连接等。TCP 是面向连接的，因而双方要维护连接的状态，这些带状态位的包的发送，会引起双方的状态变更。



TCP通过序列号与确认应答提高可靠性

> - 在 TCP 中，当发送端的数据到达接收主机时，接收端主机会返回一个已收到消息的通知。这个消息叫做确认应答（ACK）。当发送端将数据发出之后会等待对端的确认应答。如果有确认应答，说明数据已经成功到达对端。**反之，则数据丢失的可能性很大**。
> - 在一定时间内没有等待到确认应答，发送端就可以认为数据已经丢失，并进行重发。由此，即使产生了丢包，仍然能够保证数据能够到达对端，实现可靠传输。
> - 未收到确认应答并不意味着数据一定丢失。也有可能是数据对方已经收到，只是返回的确认应答在途中丢失。这种情况也会导致发送端误以为数据没有到达目的地而重发数据。
> - 此外，也有可能因为一些其他原因导致确认应答延迟到达，在源主机重发数据以后才到达的情况也屡见不鲜。此时，源主机只要按照机制重发数据即可。
> - 对于目标主机来说，反复收到相同的数据是不可取的。为了对上层应用提供可靠的传输，目标主机必须放弃重复的数据包。为此我们引入了序列号。
> - **序列号是按照顺序给发送数据的每一个字节（8位字节）都标上号码的编号。接收端查询接收数据 TCP 首部中的序列号和数据的长度，将自己下一步应该接收的序列号作为确认应答返送回去。通过序列号和确认应答号，TCP 能够识别是否已经接收数据，又能够判断是否需要接收，从而实现可靠传输。**

![](../img/tcp_transport.png)

TCP在每次都需要等待确认包回来后才进行下一个包的发送，这个方式被叫**停等协议**，TCP为解决这个问题，引入了窗口的概念。允许发送方发送多个分组而无需等待确认。

```mermaid
sequenceDiagram
    A(发送方)->>B(接收方): send data1
    A(发送方)->>B(接收方): send data2
    A(发送方)->>B(接收方): send data3

    B(接收方)->>A(发送方): send ack1
    B(接收方)->>A(发送方): send ack2
    B(接收方)->>A(发送方): send ack3
```



从上面我们知道，发送方可以一次发送多个分组，那到底一次能发多少呢？如果不管三七二十一一股脑的全丢给接收方，接收方一下子也接收不了啊是不是。

TCP就通过窗口模式来进行“流量控制”，发送方有要根据接收方最大能收取的数量来判断是否继续发送数据包。

如下图所示，在发送方和接收方都有一个窗口大小，分别为4种类型：

- 已经发送并被确认的分组，在 [ 0, base-1 ]区间内。
- 已经发送但未被确认的分组，在 [ base, nextseqnum-1 ]内。
- 要立即被发送的分组，对应 [ nextseqnum, N-1 ]内
- 大于或等于base+N的序号是不可用的，直到当前流水线中未被确认的分组已得到确认为止。

![](../img/tcp_windows_ptc.png)

窗口的大小控制处理流程如下图：

![](../img/tcp_windows_ptl2.png)

- 发送方可以同时发送多个数据出去，接收方也可以同时接收多个数据。
- 发送方的窗口大小是根据接收方来确定的。
- 发送方一次发送完窗口的数据后不再发送，等待确认信息回来后再移动窗口，否则就要进行超时重传。已确认的信息就可以从缓存区中清除掉了。<u>（注意必须是收到顺序排列的序号才能移动窗口，比如上图收到1号数据包的确认后，才可以把窗口移动到1001号数据包，如果我没收到1号的确认，收到了1001号的确认，窗口是不会移动的，只会等待）</u>
- 接收方也可以一次接收多个消息，然后一个一个回应确认消息。接收窗口满了则不再接收数据，并且会通知发送方等会再发送信息，接收方的确认信息是按顺序进行回应的，比如我收到了4001的数据就不会回应确认信息，只有等到我4001之前的消息都收到了才会回应4001的确认信息。



## TCP的拥塞控制

